<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programa de Fidelidade - Check-in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --cor-vinho: #9A3324; --cor-amarelo: #D59A1D; }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .btn-primary { background-color: var(--cor-vinho); }
        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:disabled { background-color: #9A332480; }
        .text-theme { color: var(--cor-vinho); }
        .loader { border-top-color: var(--cor-vinho); -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app" class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8 text-center transition-all duration-300">
        <div id="initial-loading-screen" class="flex flex-col items-center justify-center h-64">
             <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4"></div>
             <p class="text-lg text-gray-600">A iniciar sistema de fidelidade...</p>
        </div>
        <div id="checkin-screen" class="hidden">
            <img src="https://i.imgur.com/83uVBmy.png" alt="Logomarca Isto e aQuilo" class="h-20 mx-auto mb-6"/>
            <p class="text-gray-600 mb-6">Faça seu check-in para ganhar selos.</p>
            <div class="bg-gray-100 rounded-lg p-4 mb-6">
                <p class="text-gray-500 text-sm">Nº de Celular (com DDD)</p>
                <div id="phone-display" class="text-4xl font-bold text-gray-800 h-12 tracking-wider"></div>
            </div>
            <div id="keypad" class="grid grid-cols-3 gap-4 mb-6"></div>
            <button id="checkin-button" class="w-full btn-primary text-white font-bold py-4 rounded-lg text-lg transition-colors disabled:cursor-not-allowed">Fazer Check-in</button>
            <div class="mt-8 text-center">
                 <p class="text-gray-500">Ainda não é membro?</p>
                 <p class="font-semibold text-theme">Aponte a câmara para o QR Code e cadastre-se!</p>
            </div>
        </div>
        <div id="result-screen" class="hidden">
            <div id="result-icon" class="mx-auto mb-4"></div>
            <h2 id="result-title" class="text-3xl font-bold mb-2"></h2>
            <p id="result-message" class="text-gray-600 text-lg mb-4"></p>
            <div id="selos-container" class="my-6"></div>
            <button id="back-button" class="mt-4 bg-gray-200 text-gray-800 font-bold py-3 px-8 rounded-lg hover:bg-gray-300 transition-colors">Voltar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-fidelidade-app';
        const RESTAURANT_ID = "COLOQUE_O_ID_DA_UNIDADE_AQUI"; // IMPORTANTE: Substituir pelo ID da unidade

        let db; let selosParaRecompensa = 12; let diasValidadeSelo = 30;
        const checkinScreen = document.getElementById('checkin-screen');
        const resultScreen = document.getElementById('result-screen');
        const initialLoadingScreen = document.getElementById('initial-loading-screen');
        const phoneDisplay = document.getElementById('phone-display');
        const keypad = document.getElementById('keypad');
        const checkinButton = document.getElementById('checkin-button');
        const backButton = document.getElementById('back-button');

        async function initialize() {
            try {
                if (Object.keys(firebaseConfig).length === 0 || RESTAURANT_ID === "COLOQUE_O_ID_DA_UNIDADE_AQUI") {
                   showFatalError("Sistema não configurado. Contacte o suporte."); return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app); await signInAnonymously(getAuth(app));
                await fetchConfigurations(); setupUI();
                initialLoadingScreen.classList.add('hidden'); checkinScreen.classList.remove('hidden');
            } catch (error) { console.error("Erro na inicialização:", error); showFatalError("Não foi possível conectar ao sistema."); }
        }
        function showFatalError(message) { initialLoadingScreen.innerHTML = `<h2 class="text-2xl font-bold text-red-600 mb-2">Erro Crítico</h2><p class="text-gray-600">${message}</p>`; initialLoadingScreen.classList.remove('hidden'); checkinScreen.classList.add('hidden'); }
        async function fetchConfigurations() {
            try {
                const configRef = doc(db, `artifacts/${appId}/public/data/restaurants/${RESTAURANT_ID}/configuracoes/main`);
                const configDoc = await getDoc(configRef);
                if (configDoc.exists()) {
                    const d = configDoc.data(); selosParaRecompensa = d.selosParaRecompensa || 12; diasValidadeSelo = d.diasValidadeSelo || 30;
                }
            } catch (error) { console.error("Erro ao buscar configurações:", error); }
        }
        function setupUI() {
            ['1', '2', '3', '4', '5', '6', '7', '8', '9', 'Corrigir', '0', ''].forEach(key => {
                const button = document.createElement('button');
                button.className = "py-4 text-2xl font-bold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-vinho";
                button.textContent = key;
                if (key === 'Corrigir') { button.onclick = () => { phoneDisplay.textContent = phoneDisplay.textContent.slice(0, -1); }; button.classList.add("text-base", "bg-amarelo", "hover:opacity-90", "text-white"); } 
                else if (key !== '') { button.onclick = () => { if (phoneDisplay.textContent.length < 11) phoneDisplay.textContent += key; }; } 
                else { button.className = ''; button.disabled = true; }
                keypad.appendChild(button);
            });
            checkinButton.onclick = handleCheckin; backButton.onclick = resetApp;
        }
        async function handleCheckin() {
            const phoneNumber = phoneDisplay.textContent;
            if (phoneNumber.length !== 11) { showResult('warning', 'Atenção', `O número de celular deve ter 11 dígitos (DDD + Número).`); return; }
            showLoadingState(true);
            try {
                const basePath = `artifacts/${appId}/public/data/restaurants/${RESTAURANT_ID}`;
                const clienteRef = doc(db, `${basePath}/clientes`, phoneNumber);
                const clienteDoc = await getDoc(clienteRef);
                if (!clienteDoc.exists()) { showResult('error', 'Cliente não encontrado', 'Por favor, realize seu cadastro primeiro usando o QR Code.'); return; }
                const clienteData = clienteDoc.data(); const clienteId = clienteDoc.id;
                const rQuery = query(collection(db, `${basePath}/recompensas`), where("clienteId", "==", clienteId), where("status", "==", "disponivel"));
                if (!(await getDocs(rQuery)).empty) { showResult('info', `Olá, ${clienteData.nome.split(' ')[0]}!`, 'Você já tem um almoço grátis para resgatar. Avise ao caixa na sua próxima visita!'); return; }
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const cQuery = query(collection(db, `${basePath}/checkins`), where("clienteId", "==", clienteId), where("dataCheckin", ">=", today));
                if (!(await getDocs(cQuery)).empty) { showResult('warning', `Olá, ${clienteData.nome.split(' ')[0]}!`, 'Você já fez o seu check-in hoje. Volte amanhã!'); return; }
                const batch = writeBatch(db); const agora = new Date();
                const selosValidosQuery = query(collection(db, `${basePath}/checkins`), where("clienteId", "==", clienteId), where("status", "==", "valido"));
                const selosValidosSnapshot = await getDocs(selosValidosQuery);
                let selosAtuais = 0;
                selosValidosSnapshot.forEach(doc => { if (doc.data().dataExpiracao.toDate() < agora) batch.update(doc.ref, { status: 'expirado' }); else selosAtuais++; });
                const dataExpiracao = new Date(); dataExpiracao.setDate(dataExpiracao.getDate() + diasValidadeSelo);
                const novoCheckinRef = doc(collection(db, `${basePath}/checkins`));
                batch.set(novoCheckinRef, { clienteId: clienteId, dataCheckin: serverTimestamp(), dataExpiracao: dataExpiracao, status: 'valido' });
                selosAtuais++;
                if (selosAtuais >= selosParaRecompensa) {
                    const novaRecompensaRef = doc(collection(db, `${basePath}/recompensas`));
                    batch.set(novaRecompensaRef, { clienteId: clienteId, dataGerada: serverTimestamp(), status: 'disponivel', dataResgate: null });
                    let selosParaResgatar = selosParaRecompensa;
                    selosValidosSnapshot.forEach(doc => { if (selosParaResgatar > 0) { batch.update(doc.ref, { status: 'resgatado' }); selosParaResgatar--; }});
                    batch.update(novoCheckinRef, {status: 'resgatado'});
                    batch.update(clienteRef, { selosValidos: 0 });
                    await batch.commit();
                    showResult('reward', `PARABÉNS, ${clienteData.nome.split(' ')[0]}!`, `Você ganhou um almoço grátis! Apresente esta mensagem ao caixa em sua **próxima visita** para resgatar.`, 0, selosParaRecompensa);
                } else {
                    batch.update(clienteRef, { selosValidos: selosAtuais });
                    await batch.commit();
                    showResult('success', `Check-in realizado!`, `Olá, ${clienteData.nome.split(' ')[0]}! Você tem ${selosAtuais} de ${selosParaRecompensa} selos.`, selosAtuais, selosParaRecompensa);
                }
            } catch (error) { console.error("Erro no check-in:", error); showResult('error', 'Erro no Sistema', 'Ocorreu um problema ao processar seu check-in. Tente novamente.'); } 
            finally { showLoadingState(false); }
        }
        function showResult(type, title, message, selos = 0, total = selosParaRecompensa) {
            checkinScreen.classList.add('hidden'); resultScreen.classList.remove('hidden');
            const resultIcon = document.getElementById('result-icon');
            resultIcon.innerHTML = getIcon(type);
            document.getElementById('result-title').textContent = title;
            document.getElementById('result-message').innerHTML = message;
            const selosContainer = document.getElementById('selos-container');
            if (type === 'success' || type === 'reward') {
                selosContainer.innerHTML = '';
                for(let i = 1; i <= total; i++) {
                    const seloEl = document.createElement('div');
                    seloEl.className = `w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg ${i <= selos ? 'bg-green-500' : 'bg-gray-300'}`;
                    seloEl.innerHTML = getIcon('selo');
                    selosContainer.appendChild(seloEl);
                }
                selosContainer.className = 'my-6 flex flex-wrap justify-center gap-3';
            } else { selosContainer.innerHTML = ''; }
            if(type !== 'error') setTimeout(resetApp, 8000);
        }
        function getIcon(type) {
             const iconClasses = "w-20 h-20 mx-auto";
             const colors = { success: 'text-green-500', warning: 'text-yellow-500', error: 'text-red-500', info: 'text-blue-500', reward: 'text-amarelo' };
             if (type === 'selo') return `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
             const path = {
                success: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z",
                warning: "M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z",
                error: "M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z",
                info: "M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
                reward: "M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z",
             };
             return `<svg class="${iconClasses} ${colors[type]}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${path[type]}"></path></svg>`;
        }
        function showLoadingState(isLoading) {
            checkinButton.disabled = isLoading;
            if (isLoading) checkinButton.innerHTML = `<div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mx-auto"></div>`;
            else checkinButton.textContent = 'Fazer Check-in';
        }
        function resetApp() { phoneDisplay.textContent = ''; resultScreen.classList.add('hidden'); checkinScreen.classList.remove('hidden'); }
        initialize();
    </script>
</body>
</html>