<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programa de Fidelidade - Cadastro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --cor-vinho: #9A3324; --cor-amarelo: #D59A1D; }
        body { font-family: 'Inter', sans-serif; background-color: #F9FAFB; }
        .form-input:focus { border-color: var(--cor-vinho); box-shadow: 0 0 0 2px var(--cor-vinho); }
        .btn-primary { background-color: var(--cor-vinho); }
        .btn-primary:hover { opacity: 0.9; }
        .link { color: var(--cor-vinho); }
        .checkbox-custom:checked { background-color: var(--cor-vinho); border-color: var(--cor-vinho); }
        .loader { border-top-color: var(--cor-vinho); animation: spinner 1.5s linear infinite; }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="container mx-auto max-w-lg p-4 sm:p-6">
        <div id="main-container" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <div class="text-center mb-8">
                <img src="https://i.imgur.com/83uVBmy.png" alt="Logomarca Isto e aQuilo" class="h-20 mx-auto mb-4"/>
                <p class="text-gray-500 mt-2">Junte-se ao nosso programa de fidelidade e ganhe prémios!</p>
            </div>

            <form id="cadastro-form" class="space-y-5">
                <div><label for="nome" class="form-label">Nome Completo</label><input type="text" id="nome" name="nome" class="form-input" required></div>
                <div><label for="celular" class="form-label">Nº de Celular (com DDD)</label><input type="tel" id="celular" name="celular" class="form-input" required placeholder="Ex: 31912345678" pattern="\d{11}"></div>
                <div><label for="email" class="form-label">Email</label><input type="email" id="email" name="email" class="form-input" required></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="nascimento" class="form-label">Data de Nascimento</label><input type="date" id="nascimento" name="nascimento" class="form-input" required></div>
                    <div><label for="cpf" class="form-label">CPF</label><input type="text" id="cpf" name="cpf" class="form-input" required placeholder="___.___.___-__"></div>
                </div>
                <div><label for="sexo" class="form-label">Sexo</label><select id="sexo" name="sexo" class="form-input"><option value="">Prefiro não informar</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option><option value="outro">Outro</option></select></div>
                <div class="pt-4 space-y-3">
                    <div class="flex items-start"><input id="lgpd" name="lgpd" type="checkbox" class="h-4 w-4 checkbox-custom border-gray-300 rounded focus:ring-vinho mt-1" required><div class="ml-3 text-sm"><label for="lgpd" class="font-medium text-gray-700">Eu li e concordo com os <a href="#" id="open-policy-modal" class="link hover:underline">Termos e Política de Privacidade</a>.</label></div></div>
                    <div class="flex items-start"><input id="comunicacao" name="comunicacao" type="checkbox" class="h-4 w-4 checkbox-custom border-gray-300 rounded focus:ring-vinho mt-1" checked><div class="ml-3 text-sm"><label for="comunicacao" class="font-medium text-gray-700">Aceito receber e-mails e notificações com novidades e promoções.</label></div></div>
                </div>
                <div class="pt-4"><button type="submit" id="submit-button" class="w-full btn-primary text-white font-bold py-3 rounded-lg text-lg transition-colors disabled:opacity-50">Finalizar Cadastro</button></div>
            </form>
        </div>
        
        <div id="result-screen" class="hidden bg-white p-8 rounded-2xl shadow-lg text-center">
        </div>
    </div>
    
    <div id="policy-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3 text-left"><h3 class="text-lg leading-6 font-medium text-gray-900">Termos e Política de Privacidade</h3><div class="mt-2 px-7 py-3 max-h-96 overflow-y-auto"><p class="text-sm text-gray-500"><strong>1. Coleta de Dados:</strong> Ao se cadastrar, coletamos nome, celular, e-mail, data de nascimento, CPF e sexo para gerir a sua participação no programa de fidelidade. <br><br><strong>2. Uso dos Dados:</strong> Os seus dados são usados para identificar os seus check-ins, atribuir selos, conceder recompensas e, caso autorize, comunicar novidades ou promoções do restaurante, incluindo ofertas de aniversário.<br><br><strong>3. Armazenamento:</strong> Os seus dados são armazenados de forma segura na plataforma Firebase do Google.<br><br><strong>4. Direitos do Titular:</strong> Você pode, a qualquer momento, solicitar acesso, correção, exclusão dos seus dados ou revogar o seu consentimento para comunicações através do nosso painel de administração ou contactando o restaurante.<br><br><strong>5. Compartilhamento:</strong> Não compartilhamos os seus dados com terceiros.</p></div><div class="items-center px-4 py-3"><button id="close-policy-modal" class="px-4 py-2 btn-primary text-white text-base font-medium rounded-md w-full shadow-sm">Entendi e Concordo</button></div></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-fidelidade-app';
        let RESTAURANT_ID; let db;
        const mainContainer = document.getElementById('main-container');
        const resultScreen = document.getElementById('result-screen');
        const form = document.getElementById('cadastro-form');
        async function initialize() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                RESTAURANT_ID = urlParams.get('unitId');
                if (Object.keys(firebaseConfig).length === 0 || !RESTAURANT_ID) {
                    showResult('error', "Erro de Configuração", "O link de cadastro é inválido ou está incompleto. Por favor, utilize o QR Code fornecido pelo restaurante.");
                    document.getElementById('cadastro-form').classList.add('hidden');
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                await signInAnonymously(getAuth(app));
                document.getElementById('cadastro-form').addEventListener('submit', handleCadastro);
                document.getElementById('cpf').addEventListener('input', (e) => {
                    let v = e.target.value.replace(/\D/g, '').substring(0, 11);
                    e.target.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                });
                document.getElementById('open-policy-modal').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('policy-modal').classList.remove('hidden'); });
                document.getElementById('close-policy-modal').addEventListener('click', () => { document.getElementById('policy-modal').classList.add('hidden'); document.getElementById('lgpd').checked = true; });
            } catch (error) { console.error("Erro na inicialização:", error); showResult('error', "Erro de Conexão", "Não foi possível conectar ao sistema."); }
        }
        async function handleCadastro(event) {
            event.preventDefault();
            const formData = new FormData(form);
            const celular = formData.get('celular').replace(/\D/g, '');
            const cpf = formData.get('cpf').replace(/\D/g, '');
            if (celular.length !== 11) { alert("Por favor, insira um número de celular válido com 11 dígitos (DDD + número)."); return; }
            if (cpf.length !== 11) { alert("Por favor, insira um CPF válido com 11 dígitos."); return; }
            document.getElementById('submit-button').disabled = true;
            try {
                const clienteRef = doc(db, `artifacts/${appId}/public/data/restaurants/${RESTAURANT_ID}/clientes`, celular);
                if ((await getDoc(clienteRef)).exists()) { showResult('warning', 'Cadastro existente', 'Este número de celular já está cadastrado. Pode fazer o seu check-in no tablet!'); return; }
                await setDoc(clienteRef, { nome: formData.get('nome'), email: formData.get('email'), celular: celular, dataNascimento: new Date(formData.get('nascimento')), cpf: cpf, sexo: formData.get('sexo'), lgpdAceite: true, aceitaComunicacao: formData.get('comunicacao') === 'on', dataCadastro: serverTimestamp(), selosValidos: 0 });
                showResult('success', 'Cadastro realizado!', 'Seja bem-vindo! Agora já pode usar o seu celular para fazer check-in no tablet do restaurante.');
            } catch (error) { console.error("Erro ao cadastrar:", error); showResult('error', 'Erro no Sistema', 'Ocorreu um problema ao realizar o seu cadastro. Tente novamente.'); }
        }
        function showResult(type, title, message) {
            mainContainer.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            let colorClass = 'text-gray-500';
            if (type === 'success') colorClass = 'text-green-500';
            if (type === 'warning') colorClass = 'text-yellow-500';
            if (type === 'error') colorClass = 'text-red-500';
            resultScreen.innerHTML = `<div class="mx-auto mb-4 w-20 h-20 ${colorClass}">${getIcon(type)}</div><h2 class="text-3xl font-bold mb-2">${title}</h2><p class="text-gray-600 text-lg">${message}</p>`;
        }
        function getIcon(type) {
            if (type === 'success') return `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            if (type === 'warning') return `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
            return `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        }
        initialize();
    </script>
</body>
</html>